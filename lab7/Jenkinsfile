pipeline {
    agent any 
    stages{
        stage('Qemu') {
            steps{
                echo 'Start qemu'
                sh '''
                apt-get update
                apt-get install -y qemu-system-arm wget unzip expect
                rm -rf romulus romulus.zip || true
                wget "$ROMULUS_ZIP_URL" -O romulus.zip
                unzip -o romulus.zip
                LATEST_MTD=$(ls romulus/obmc-phosphor-image-romulus-*.static.mtd | sort -V | tail -1)
                nohup qemu-system-arm -m 256 -M romulus-bmc -nographic \
                -drive file=$LATEST_MTD,format=raw,if=mtd \
                -net nic \
                -net user,hostfwd=:0.0.0.0:2222-:22,hostfwd=:0.0.0.0:2443-:443,hostfwd=udp:0.0.0.0:2623-:623,hostname=qemu \
                > qemu.log 2>&1 &
                echo $! > qemu.pid
                sleep 90 
                '''
            }
            }

        stage('Auto') {
            steps{
                echo 'Start autotests and WebUI tests'
                sh 'apt install -y python3'
                sh 'apt install -y python3-pytest'
                sh 'apt install -y python3-selenium'
                sh 'apt install -y python3-requests'
                catchError(buildResult: 'SUCCESS', stageResult: 'UNSTABLE'){
                    sh '''cd lab4
                    ls
                    python3 -m pytest -v tests.py > web_results.txt 2>&1'''
                }
                sh 'cd ..'
                catchError(buildResult: 'SUCCESS', stageResult: 'UNSTABLE'){
                    sh '''cd lab5
                    ls
                    python3 -m pytest -v test_redfish.py > autotest_results.txt 2>&1'''
                }
                sh 'cd ..'

            }

        }
        
        stage('Locust') {
            steps{
                echo 'Start Locust tests'
                sh 'apt install -y python3 locust'
                sh 'apt install -y python3-requests'

                catchError(buildResult: 'SUCCESS', stageResult: 'UNSTABLE'){
                    sh '''cd lab6
                    ls
                    timeout 180 locust --headless --users 50 --spawn-rate 5 --run-time 3m --host=https://127.0.0.1:2443 > locust_results.txt 2>&1'''
                }
                sh 'cd ..'
            }
        }
        stage('Stop Qemu') {
            steps {
                sh '''
                    echo "Stop Qemu..."
                    if [ -f "qemu.pid" ]; then
                        QEMU_PID=$(cat qemu.pid)
                        kill $QEMU_PID 2>/dev/null || true
                        rm -f qemu.pid
                        echo "Qemu shutted down"
                    fi
                    rm -rf romulus/ romulus.zip || true
                    rm -f *.log *.pid *.json *.csv || true
                    rm -f qemu.pid image_path.txt config.env || true
                    du -sh . | awk '{print $1}'
                '''
            }
        }
    }
    post {
        always {
            archiveArtifacts artifacts: '**/*.txt', fingerprint: true
            }
        }
}